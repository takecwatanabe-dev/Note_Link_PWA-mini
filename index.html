<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
<title>Note Link mini – launcher fix (R-28｜2025-09-21 23:50 JST)</title>
<style>
  :root{
    --ink:#e6f1ff;
    --bg:#0b0f1a;
    --panel:#101722;
    --accent:#4f7cff;
    --accent-weak:#2a54ff55;
    --shadow:0 10px 24px rgba(0,0,0,.45);
    --topbar-h:44px;              /* 実測でJSが上書きします */
    --toolbar-w:56px;
  }
  html,body{height:100%; background:var(--bg); color:var(--ink); margin:0; font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Hiragino Kaku Gothic ProN","Meiryo",sans-serif;}
  *,*:before,*:after{box-sizing:border-box}

  /* ====== 上部メインバー ====== */
  header.topbar{
    position:sticky; top:0; left:0; right:0; z-index:50;
    height:var(--topbar-h); display:flex; align-items:center; gap:8px;
    padding:6px 10px;
    background:linear-gradient(0deg,var(--accent-weak),#2a54ff33);
    border-bottom:1px solid rgba(255,255,255,.08);
    backdrop-filter: blur(8px);
  }
  .topbar .btn{
    height:28px; padding:0 10px; border-radius:10px; font-size:12px;
    display:inline-flex; align-items:center; justify-content:center;
    background:rgba(255,255,255,.12); color:var(--ink); border:1px solid rgba(255,255,255,.18);
    user-select:none; cursor:pointer;
  }
  .topbar .btn:active{ transform:translateY(1px) }

  /* ====== レイアウト ====== */
  #wrap{ position:relative; }
  #stage{
    position:absolute; inset:0;
    top:var(--topbar-h);
    padding-left:var(--toolbar-w);
  }
  canvas#paper{ display:block; width:100%; height:100%; }

  /* ====== 左ツールバー（見た目だけ・今回最小） ====== */
  aside.toolbar{
    position:absolute; top:var(--topbar-h); left:0; bottom:0; width:var(--toolbar-w);
    display:flex; flex-direction:column; gap:8px; padding:6px;
    background:rgba(0,0,0,.28); box-shadow:0 0 0 1px rgba(255,255,255,.05) inset;
    z-index:40;
  }
  .tool{
    width:36px; height:36px; border-radius:10px; display:grid; place-items:center;
    color:var(--ink); cursor:pointer; background:rgba(255,255,255,.06);
    border:1px solid rgba(255,255,255,.12);
    outline:2px solid transparent; transition:outline-color .12s ease;
  }
  .tool svg{ width:18px; height:18px }
  .tool.active{ outline-color:#20e3c2; }          /* 緑の選択枠 */

  /* ====== スタート画面（ランチャー） ====== */
  #launcher{
    position:fixed; inset:0; z-index:1000; display:grid; place-items:center;
    background:rgba(0,0,0,.45);
    opacity:0; pointer-events:none; transition:opacity .15s ease;
  }
  #launcher[data-open="true"]  { opacity:1; pointer-events:auto; }
  #launcher[data-open="false"] { opacity:0; pointer-events:none; }

  .sheet{
    width:min(920px,92vw);
    background:var(--panel); border:1px solid rgba(255,255,255,.12);
    border-radius:14px; box-shadow:var(--shadow); padding:18px;
  }
  .sheet h2{ margin:4px 0 14px; font-size:16px }
  .grid3{
    display:grid; grid-template-columns:1fr 1fr 1fr; gap:14px;
  }
  .card{
    background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.12);
    border-radius:12px; padding:14px;
  }
  .card h3{ margin:0 0 10px; font-size:14px }
  .card .btn{ margin-top:8px }

  /* about:blank抑止のため印刷用の iframe は使わない（同タブ印刷） */

  /* スクロール時の安全策（PWAやモバイルでの余計なジェスチャ抑制） */
  #stage, canvas{ touch-action:none; }
</style>
</head>
<body>
  <header class="topbar" id="topbar">
    <span style="opacity:.75; font-size:12px; padding:0 6px">Note Link v0.7.0 / No.13</span>
    <span class="spacer" style="flex:1"></span>
    <button class="btn" id="zoomOut">−</button>
    <button class="btn" id="zoomReset">100%</button>
    <button class="btn" id="zoomIn">＋</button>
    <button class="btn" id="undoBtn">undo</button>
    <button class="btn" id="redoBtn">redo</button>
    <button class="btn" id="printBtn">印刷</button>
    <button class="btn" id="pngBtn">PNG</button>
    <button class="btn" id="shareBtn">共有</button>
  </header>

  <div id="wrap">
    <aside class="toolbar" id="toolbar">
      <div class="tool active" id="tool-pen" title="ペン">
        <!-- ペン -->
        <svg viewBox="0 0 24 24" fill="none"><path d="M3 21l3.5-.7L19 7.8 16.2 5 4.7 16.5 4 20zM14 6l4 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
      </div>
      <div class="tool" id="tool-eraser" title="消しゴム">
        <svg viewBox="0 0 24 24" fill="none"><path d="M6 19h12M3 14l8-8a2 2 0 012.8 0l4.2 4.2a2 2 0 010 2.8l-8 8H7.8a2 2 0 01-1.4-.6L3.6 16a2 2 0 010-2.8z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
      </div>
      <div class="tool" id="tool-hand" title="ハンド">
        <svg viewBox="0 0 24 24" fill="none"><path d="M8 13V7a1 1 0 012 0v4m2 2V5a1 1 0 012 0v8m2-2V7a1 1 0 012 0v6m-8 3l-1 5h8l4-8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
      </div>
      <div class="tool" id="tool-keyboard" title="テキスト">
        <!-- キーボード -->
        <svg viewBox="0 0 24 24" fill="none"><rect x="3" y="7" width="18" height="10" rx="2" stroke="currentColor" stroke-width="2"/><path d="M6 10h2M10 10h2M14 10h2M18 10h0M6 13h8M16 13h2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
      </div>
      <div class="tool" id="tool-gear" title="設定（今回はダミー）">
        <!-- ギア（白） -->
        <svg viewBox="0 0 24 24" fill="none"><path d="M12 15.5a3.5 3.5 0 110-7 3.5 3.5 0 010 7z" stroke="currentColor" stroke-width="2"/><path d="M19 12a7 7 0 01-.1 1.2l2 1.6-2 3.5-2.3-.9a7.2 7.2 0 01-2 .9L14 22h-4l-.6-2.8a7.2 7.2 0 01-2-.9l-2.3.9-2-3.5 2-1.6A7 7 0 015 12c0-.4 0-.8.1-1.2l-2-1.6 2-3.5 2.3.9a7.2 7.2 0 012-.9L10 2h4l.6 2.8a7.2 7.2 0 012 .9l2.3-.9 2 3.5-2 1.6c.1.4.1.8.1 1.2z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
      </div>
    </aside>

    <main id="stage">
      <canvas id="paper"></canvas>
    </main>
  </div>

  <!-- ====== スタート画面（最初は data-open="true"） ====== -->
  <div id="launcher" data-open="true" aria-modal="true" role="dialog">
    <div class="sheet">
      <h2>まず選んでください</h2>
      <div class="grid3">
        <section class="card">
          <h3>① 過去のノートを開く</h3>
          <div style="opacity:.7">履歴はありません</div>
        </section>
        <section class="card">
          <h3>② 新規ノート作成</h3>
          <div style="display:flex; gap:8px; align-items:center; margin:8px 0">
            <label>サイズ
              <select id="sel-size">
                <option value="A4" selected>A4</option>
                <option value="B5">B5</option>
                <option value="Letter">Letter</option>
              </select>
            </label>
            <label>向き
              <select id="sel-orient">
                <option value="p" selected>縦</option>
                <option value="l">横</option>
              </select>
            </label>
          </div>
          <button class="btn" id="btn-create">作成</button>
        </section>
        <section class="card">
          <h3>③ 先生からの課題を読み込む</h3>
          <input type="file" id="pdf-input" accept="application/pdf,image/*" />
          <div style="opacity:.6; font-size:12px; margin-top:6px">※PDFは1ページ目を画像化して背景に配置します</div>
          <button class="btn" id="btn-import" style="margin-top:8px">読み込む</button>
        </section>
      </div>
    </div>
  </div>

<script>
/* R-28 launcher-freeze fix: data-open="true/false" を厳密に扱い、
   閉じてから初期化（1フレーム遅延）で固まりを防止。 */

const $ = (s, el=document) => el.querySelector(s);
const topbar = $('#topbar');
const stage  = $('#stage');
const canvas = $('#paper');
const ctx    = canvas.getContext('2d', {alpha:false, desynchronized:true});
let dpr = Math.max(1, Math.floor(window.devicePixelRatio || 1));
let hist = [], redoStack = [];
const nextFrame = () => new Promise(r => requestAnimationFrame(()=>setTimeout(r,0)));

function measureTopHeights(){
  const tb = topbar.getBoundingClientRect();
  document.documentElement.style.setProperty('--topbar-h', tb.height+'px');
  // サイドバー top も同期
  const sidebarTop = tb.height;
  document.documentElement.style.setProperty('--sidebar-top', sidebarTop+'px');
}
measureTopHeights();
addEventListener('resize', measureTopHeights);
addEventListener('orientationchange', measureTopHeights);
addEventListener('visibilitychange', measureTopHeights);

function fitCanvas(){
  const rect = stage.getBoundingClientRect();
  const w = Math.max(1, Math.floor(rect.width  * dpr));
  const h = Math.max(1, Math.floor(rect.height * dpr));
  if (canvas.width !== w || canvas.height !== h){
    canvas.width = w; canvas.height = h;
  }
  canvas.style.width  = rect.width + 'px';
  canvas.style.height = rect.height + 'px';
  ctx.setTransform(1,0,0,1,0,0);
  ctx.scale(dpr, dpr);
  ctx.fillStyle = "#0c1220";
  ctx.fillRect(0,0, rect.width, rect.height);
}
new ResizeObserver(fitCanvas).observe(stage);

function openLauncher(){ const l = $('#launcher'); l?.setAttribute('data-open','true'); }
function closeLauncher(){ const l = $('#launcher'); l?.setAttribute('data-open','false'); }

function resetNoteState(){
  hist = []; redoStack = [];
  ctx.clearRect(0,0, canvas.width, canvas.height);
  fitCanvas();
  pushHistory(); // 初期スナップ
}

function pushHistory(){
  try{
    const data = canvas.toDataURL('image/webp', .85);
    hist.push(data);
    if (hist.length > 10) hist.shift();
  }catch(e){ console.warn(e); }
}
function restoreFrom(dataURL){
  return new Promise((resolve,reject)=>{
    const img = new Image();
    img.onload = ()=>{ fitCanvas(); ctx.drawImage(img,0,0,canvas.clientWidth,canvas.clientHeight); resolve(); };
    img.onerror = reject;
    img.src = dataURL;
  });
}
$('#undoBtn').addEventListener('click', async ()=>{
  if (hist.length <= 1) return;
  const cur = hist.pop(); redoStack.push(cur);
  const prev = hist[hist.length-1];
  await restoreFrom(prev);
});
$('#redoBtn').addEventListener('click', async ()=>{
  const pop = redoStack.pop();
  if (!pop) return;
  await restoreFrom(pop);
  hist.push(pop);
});

$('#btn-create').addEventListener('click', async (e)=>{
  e.preventDefault();
  const btn = e.currentTarget; btn.disabled = true;
  try{
    closeLauncher();
    await nextFrame();    // ← これで「閉じる→初期化」の順が確定し固まりを防ぐ
    resetNoteState();
  }catch(err){
    console.error(err);
    alert('初期化に失敗しました。もう一度お試しください。');
    openLauncher();
  }finally{
    btn.disabled = false;
  }
});

$('#btn-import').addEventListener('click', async ()=>{
  const f = $('#pdf-input').files?.[0];
  if(!f){ alert('ファイルを選択してください'); return; }
  closeLauncher(); await nextFrame(); resetNoteState();
  // 簡易: 画像は直接 drawImage、PDF はサーバなしでは扱えないため今回は割愛
  if (f.type.startsWith('image/')){
    const url = URL.createObjectURL(f);
    const img = new Image(); img.src = url;
    img.onload = () => { fitCanvas(); ctx.drawImage(img, 0,0, canvas.clientWidth, canvas.clientHeight); pushHistory(); URL.revokeObjectURL(url); };
  } else {
    alert('PDFの直接描画はこの最小版では未対応です（画像にして読み込んでください）');
  }
});

$('#printBtn').addEventListener('click', ()=> window.print());
$('#pngBtn').addEventListener('click', ()=>{
  canvas.toBlob(b=>{
    const u = URL.createObjectURL(b);
    const a = document.createElement('a');
    a.href=u; a.download='note.png'; a.click();
    URL.revokeObjectURL(u);
  },'image/png');
});
$('#shareBtn').addEventListener('click', async ()=>{
  try{
    if (navigator.canShare && navigator.canShare()){
      canvas.toBlob(async b=>{
        const file = new File([b],'note.png',{type:'image/png'});
        await navigator.share({files:[file], title:'Note Link', text:'共有'});
      },'image/png');
    }else{
      $('#pngBtn').click();
    }
  }catch(e){ console.warn(e); }
});

/* 簡易のペン（今回の目的はランチャー固まり解消なので最低限） */
let drawing=false, last=null;
canvas.addEventListener('pointerdown', (e)=>{
  canvas.setPointerCapture?.(e.pointerId);
  drawing=true; last = {x:e.offsetX, y:e.offsetY};
});
canvas.addEventListener('pointermove', (e)=>{
  if(!drawing) return;
  ctx.strokeStyle = '#cfe9ff';
  ctx.lineWidth = 2; ctx.lineCap='round';
  ctx.beginPath(); ctx.moveTo(last.x, last.y); ctx.lineTo(e.offsetX, e.offsetY); ctx.stroke();
  last = {x:e.offsetX, y:e.offsetY};
});
canvas.addEventListener('pointerup', ()=>{
  if(drawing){ drawing=false; pushHistory(); }
});

/* 初期表示でランチャーを開く（historyがあれば閉じる運用でもOK） */
openLauncher();
fitCanvas();
</script>
</body>
</html>
