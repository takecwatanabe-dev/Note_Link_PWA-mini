<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Note Link mini — v0.7.0-mini-fix19</title>
<style>
:root{
  --ink:#e6f1ff; --ink-dim:#9bd6e9; --bg:#0b1020;
  --panel:#101827; --accent:#3f78ff; --accent-weak:#2a54ff;
  --ok:#20e3c2; --muted:#283248; --shadow:0 10px 24px rgba(0,0,0,.45);
  --topbar-h:44px; /* 実計測でJSが上書きします */
  --toolbar-w:56px;
}
*{box-sizing:border-box} html,body{height:100%;margin:0}
html{background:var(--bg);color:var(--ink);
  font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Hiragino Kaku Gothic ProN",Meiryo,sans-serif}
header.topbar{
  position:sticky;top:0;left:0;right:0;z-index:1000;
  height:var(--topbar-h);
  display:flex;align-items:center;gap:8px;padding:0 10px;font-size:12px;color:#fff;
  background:linear-gradient(0deg,rgba(42,84,255,.16),rgba(42,84,255,.16)),var(--accent);
  border-bottom:1px solid rgba(255,255,255,.15); writing-mode:horizontal-tb;
}
.topbar .spacer{flex:1}
.topbar .btn{height:28px;padding:0 10px;border-radius:10px;background:rgba(255,255,255,.2);
  border:1px solid rgba(255,255,255,.22);color:#fff;display:inline-flex;align-items:center;gap:6px}
.topbar .btn:active{transform:translateY(1px)} .build{opacity:.8}

#wrap{position:relative;height:calc(100% - var(--topbar-h))}
#stage{position:absolute;inset:0;padding-left:var(--toolbar-w)}

.sidebar{
  position:fixed;z-index:900;left:0;top:calc(env(safe-area-inset-top,0px) + var(--topbar-h));bottom:0;
  width:var(--toolbar-w);display:flex;flex-direction:column;align-items:center;
  background:rgba(0,0,0,.85);box-shadow:0 0 0 1px var(--muted) inset
}
.sidebar .rail{width:100%;padding:6px;display:flex;flex-direction:column;gap:8px}
.tool{
  display:grid;place-items:center;width:100%;height:36px;border-radius:10px;cursor:pointer;user-select:none;
  background:rgba(22,26,38,.75);border:1px solid rgba(50,60,100,.6);
  outline:2px solid rgba(79,124,255,.35);box-shadow:0 0 0 2px rgba(0,0,0,.12)
}
.tool svg{width:18px;height:18px;stroke:var(--ink);fill:none;stroke-width:2.1;stroke-linecap:round;stroke-linejoin:round}
.tool:hover{outline:2px solid rgba(79,124,255,.55)}
.tool.active{outline:2px solid var(--ok)}
.tool[data-tool="toggle"] svg{transition:transform .2s ease}
.sidebar.collapsed .tool[data-tool="toggle"] svg{transform:rotate(180deg)}
.sidebar.collapsed .rail > .tool:not([data-tool="toggle"]){display:none}
.sidebar.collapsed{clip-path:inset(0 0 calc(100% - 45px) 0)}

.panel{
  position:absolute;z-index:950;left:70px;top:calc(var(--topbar-h) + 10px);
  min-width:360px;padding:14px 14px 12px;border-radius:14px;color:var(--ink);
  background:var(--panel);border:1px solid rgba(255,255,255,.14);box-shadow:var(--shadow);
  display:none;touch-action:none;user-select:none
}
.panel.show{display:block}
.panel .row{display:flex;align-items:center;gap:10px;margin:10px 0}
.panel .row label{width:96px;font-size:12px;color:var(--ink-dim)}
.panel .close{position:absolute;right:10px;top:10px;height:26px;padding:0 10px;border-radius:8px;
  border:1px solid rgba(255,255,255,.18);background:rgba(255,255,255,.08);color:var(--ink);font-size:12px}
.panel .row button{height:26px;padding:0 10px;border-radius:8px;border:1px solid rgba(255,255,255,.18);
  background:rgba(255,255,255,.08);color:#fff}

.canvasWrap{position:absolute;inset:0;overflow:hidden;touch-action:none}
#grid,#guide,#paint{position:absolute;left:var(--toolbar-w);top:0;right:0;bottom:0}
#grid,#guide{z-index:100;pointer-events:none} #paint{z-index:80}

.text-layer{position:absolute;left:var(--toolbar-w);top:0;right:0;bottom:0;z-index:120;pointer-events:none}
.note-text{position:absolute;min-width:64px;min-height:28px;padding:4px 6px;color:#eaf3ff;background:transparent;
  outline:1px dashed rgba(255,255,255,.25);border-radius:6px;pointer-events:auto}
.note-text[contenteditable="true"]:focus{outline:2px solid var(--ok)}
.note-text .del{position:absolute;right:-8px;top:-10px;font-size:11px;color:#fff;background:#0008;border:1px solid #fff3;border-radius:8px;padding:2px 6px;display:none}
.note-text:focus-within .del{display:block}

[data-tip]{position:relative}
[data-tip]::after{content:attr(data-tip);position:absolute;left:48px;top:50%;transform:translateY(-50%);
  background:#222a;color:#fff;font-size:12px;padding:4px 8px;border-radius:8px;white-space:nowrap;pointer-events:none;opacity:0;translate:0 -4px;transition:.15s}
[data-tip]:hover::after{opacity:1;translate:0 0}

@media print{
  header.topbar,.sidebar,.panel,.build,[data-tip]::after{display:none!important}
  #stage{padding-left:0!important} body,html,#wrap{height:auto}
}
</style>
</head>
<body>
<header class="topbar" id="topbar">
  <strong>Note Link v0.7.0 / No.13</strong>
  <span class="spacer"></span>
  <button class="btn" id="btnUndo">undo</button>
  <button class="btn" id="btnRedo">redo</button>
  <button class="btn" id="btnPrint">印刷</button>
  <button class="btn" id="btnPng">PNG</button>
  <button class="btn" id="btnShare">共有</button>
  <span class="build">build: mini-fix19</span>
</header>

<aside class="sidebar" id="sidebar">
  <div class="rail">
    <!-- △/▽（底辺線を明示） -->
    <button class="tool active" data-tool="toggle" data-tip="ツールバーの開閉">
      <svg viewBox="0 0 24 24"><path d="M5 15 L12 7 L19 15 M19 15 L5 15"/></svg>
    </button>
    <button class="tool" data-tool="pen" data-tip="ペン">
      <svg viewBox="0 0 24 24"><path d="M3 21l4-1 12-12-3-3L4 17l-1 4zM14 6l3 3"/></svg>
    </button>
    <button class="tool" data-tool="marker" data-tip="マーカー">
      <svg viewBox="0 0 24 24"><path d="M3 16l10-10 5 5-10 10-5 1 1-6zM13 6l5 5"/></svg>
    </button>
    <button class="tool" data-tool="eraser" data-tip="消しゴム">
      <svg viewBox="0 0 24 24"><path d="M3 15l8-8 6 6-6 6H7zM13 7l4 4"/></svg>
    </button>
    <!-- キーボードアイコン（Tの代替） -->
    <button class="tool" data-tool="text" data-tip="テキスト">
      <svg viewBox="0 0 24 24"><rect x="3" y="7" width="18" height="10" rx="2"></rect><path d="M7 10h10M5 13h14"/></svg>
    </button>
    <button class="tool" data-tool="settings" data-tip="ツール設定（表示/非表示）">
      <svg viewBox="0 0 24 24"><path d="M12 7.5a4.5 4.5 0 1 1 0 9 4.5 4.5 0 0 1 0-9zM4 13h2l1 2-1 2H4l-1-2 1-2zm14 0h2l1 2-1 2h-2l-1-2 1-2zM8 4h2l2 1 2-1h2l1 2-1 2h-2l-2-1-2 1H8L7 6l1-2z"/></svg>
    </button>
  </div>
</aside>

<!-- 設定パネル -->
<div class="panel" id="panel">
  <button class="close" id="panelClose">閉じる</button>
  <div class="row"><label>ツール</label><div id="panelTool">-</div></div>
  <div class="row"><label>色</label><input type="color" id="uiColor" value="#cbe58a"></div>
  <div class="row"><label>太さ</label><input type="range" min="1" max="60" value="4" id="uiSize"><span id="uiSizeVal">4px</span></div>
  <div class="row" id="rowAlpha"><label>不透明度</label><input type="range" min="10" max="100" value="100" id="uiAlpha"><span id="uiAlphaVal">100%</span></div>
  <div class="row" id="rowLineCap"><label>端の形</label>
    <select id="uiCap"><option value="butt">□ 角</option><option value="round">● 丸</option></select>
  </div>
  <div class="row"><label>直線モード</label><label><input type="checkbox" id="uiStraight">（モバイル / 15°刻み）</label></div>
  <div class="row"><label>グリッド</label>
    <label><input type="checkbox" id="uiGrid"> 表示</label>
    <select id="uiGridStep"><option value="5">5mm</option><option value="10" selected>10mm</option></select>
    <input type="color" id="uiGridColor" value="#3a4f7a" />
  </div>
  <div class="row" id="rowTextOps" style="display:none">
    <label>テキスト</label>
    <button id="btnTextAdd">テキストを追加</button>
    <button id="btnTextBold">太字</button>
    <button id="btnTextIt">斜体</button>
    <button id="btnTextDel">選択削除</button>
    <button id="btnTextBoxDel">枠ごと削除</button>
  </div>
</div>

<div id="wrap"><div id="stage">
  <div class="canvasWrap" id="canvasWrap">
    <canvas id="grid"></canvas>
    <canvas id="guide"></canvas>
    <canvas id="paint"></canvas>
  </div>
  <div class="text-layer" id="textLayer"></div>
</div></div>

<script>
const $=s=>document.querySelector(s), $$=s=>[...document.querySelectorAll(s)];
const DPR=Math.max(1,devicePixelRatio||1);
const topbar=$('#topbar'), sidebar=$('#sidebar'), panel=$('#panel');
const cvGrid=$('#grid'), ctxGrid=cvGrid.getContext('2d');
const cvGuide=$('#guide'), ctxGuide=cvGuide.getContext('2d');
const cv=$('#paint'), ctx=cv.getContext('2d',{alpha:true});
const textLayer=$('#textLayer'); const canvasWrap=$('#canvasWrap');

let W=0,H=0; let tool='pen';
let color='#cbe58a', size=4, alpha=1, cap='butt';
let straightToggle=false, straightKey=false; // ← PCはShiftで、モバイルはトグル
let gridOn=false, gridStepMM=10, gridColor='#3a4f7a';
let drawing=false, startPt=null;

function applyTopbarHeight(){
  const h=Math.round(topbar.getBoundingClientRect().height);
  document.documentElement.style.setProperty('--topbar-h', h+'px');
}
function resize(){
  applyTopbarHeight();
  const r=canvasWrap.getBoundingClientRect();
  W=Math.round(r.width); H=Math.round(r.height);
  [cvGrid,cvGuide,cv].forEach(c=>{ c.width=Math.round(W*DPR); c.height=Math.round(H*DPR); c.style.width=W+'px'; c.style.height=H+'px'; });
  drawGrid(); // 再描画
}
addEventListener('resize', resize);

/* ==== toolbar ==== */
function setActiveTool(t){
  tool=t; $$('.tool').forEach(b=>b.classList.toggle('active', b.dataset.tool===t));
  $('#panelTool').textContent=t;
  // テキスト行
  $('#rowTextOps').style.display = (t==='text') ? '' : 'none';
  // α/端形
  $('#rowAlpha').style.display   = (t==='marker') ? '' : 'none';
  $('#rowLineCap').style.display = (t==='marker'||t==='pen') ? '' : 'none';
}
$$('.tool').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    const t=btn.dataset.tool;
    if(t==='toggle'){ sidebar.classList.toggle('collapsed'); return; }
    if(t==='settings'){ panel.classList.toggle('show'); // ⚙も緑化
      $$('.tool').forEach(b=>{ if(b.dataset.tool==='settings') b.classList.toggle('active', panel.classList.contains('show'));});
      return;
    }
    setActiveTool(t);
  });
});

/* ==== panel draggable (入力上では開始しない) ==== */
(()=>{
  let sx=0,sy=0,ox=0,oy=0,drag=false;
  panel.addEventListener('pointerdown',e=>{
    if(['INPUT','SELECT','BUTTON','TEXTAREA','LABEL'].includes(e.target.tagName)) return;
    drag=true; sx=e.clientX; sy=e.clientY; const r=panel.getBoundingClientRect(); ox=r.left; oy=r.top;
    panel.setPointerCapture(e.pointerId);
  },{passive:false});
  panel.addEventListener('pointermove',e=>{
    if(!drag) return;
    const nx=ox+(e.clientX-sx), ny=oy+(e.clientY-sy);
    panel.style.left=Math.max(56,nx)+'px';
    panel.style.top=Math.max(parseInt(getComputedStyle(document.documentElement).getPropertyValue('--topbar-h'))+6,ny)+'px';
  },{passive:false});
  panel.addEventListener('pointerup',()=>drag=false,{passive:false});
  $('#panelClose').addEventListener('click',()=>panel.classList.remove('show'));
})();

/* ==== panel inputs ==== */
const uiColor=$('#uiColor'), uiSize=$('#uiSize'), uiAlpha=$('#uiAlpha'),
      uiSizeVal=$('#uiSizeVal'), uiAlphaVal=$('#uiAlphaVal'),
      uiCap=$('#uiCap'), uiStraight=$('#uiStraight'),
      uiGrid=$('#uiGrid'), uiGridStep=$('#uiGridStep'), uiGridColor=$('#uiGridColor');

function syncUI(){
  uiColor.value=color; uiSize.value=size; uiSizeVal.textContent=size+'px';
  uiAlpha.value=Math.round(alpha*100); uiAlphaVal.textContent=Math.round(alpha*100)+'%';
  uiCap.value=cap; uiStraight.checked=straightToggle;
  uiGrid.checked=gridOn; uiGridStep.value=String(gridStepMM); uiGridColor.value=gridColor;
}
function onPanelChange(){
  color=uiColor.value; size=+uiSize.value; uiSizeVal.textContent=size+'px';
  alpha=+uiAlpha.value/100; uiAlphaVal.textContent=Math.round(alpha*100)+'%';
  cap=uiCap.value; straightToggle=uiStraight.checked;
  gridOn=uiGrid.checked; gridStepMM=+uiGridStep.value; gridColor=uiGridColor.value;
  drawGrid();
}
[uiColor,uiSize,uiAlpha,uiCap,uiStraight,uiGrid,uiGridStep,uiGridColor].forEach(el=>el.addEventListener('input',onPanelChange));

/* ==== grid ==== */
function mmToPx(mm){ return mm*96/25.4*DPR }
function clear(c){ c.getContext('2d').clearRect(0,0,c.width,c.height) }
function drawGrid(){
  clear(cvGrid);
  if(!gridOn) return;
  const step=mmToPx(gridStepMM);
  const ox=0.5*DPR, oy=0.5*DPR; // HiDPIでクッキリ
  const s=ctxGrid;
  s.save(); s.lineWidth=1; s.strokeStyle=gridColor+'CC';
  s.beginPath();
  for(let x=ox;x<=cvGrid.width;x+=step){ s.moveTo(x,0); s.lineTo(x,cvGrid.height); }
  for(let y=oy;y<=cvGrid.height;y+=step){ s.moveTo(0,y); s.lineTo(cvGrid.width,y); }
  s.stroke(); s.restore();
}

/* ==== draw ==== */
function setCtx(){
  ctx.lineCap=(tool==='marker'||tool==='pen')?cap:'round';
  if(tool==='marker'){ ctx.globalCompositeOperation='source-over'; ctx.strokeStyle=hexA(color,alpha) }
  else if(tool==='pen'){ ctx.globalCompositeOperation='source-over'; ctx.strokeStyle=color }
  else if(tool==='eraser'){ ctx.globalCompositeOperation='destination-out'; ctx.strokeStyle='rgba(0,0,0,1)' }
  ctx.lineWidth=size*DPR;
}
function hexA(hex,a){const m=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
  const r=parseInt(m[1],16),g=parseInt(m[2],16),b=parseInt(m[3],16); return `rgba(${r},${g},${b},${a})`;}
function pt(e){const r=cv.getBoundingClientRect();return {x:(e.clientX-r.left)*DPR,y:(e.clientY-r.top)*DPR}}
function snapLine(p0,p1){
  const dx=p1.x-p0.x, dy=p1.y-p0.y;
  let ang=Math.atan2(dy,dx), step=Math.PI/12; ang=Math.round(ang/step)*step;
  let len=Math.hypot(dx,dy);
  let x=p0.x+Math.cos(ang)*len, y=p0.y+Math.sin(ang)*len;
  if(gridOn){ // 終点を格子へ吸着
    const g=mmToPx(gridStepMM); x=Math.round(x/g)*g; y=Math.round(y/g)*g;
  }
  return {x,y,ang};
}
function drawAngleHUD(p,ang){
  clear(cvGuide);
  const dpr=DPR, s=ctxGuide; s.save(); s.translate(p.x,p.y);
  s.fillStyle='#000a'; s.strokeStyle='#ddd'; s.lineWidth=1.5*dpr;
  s.beginPath(); s.roundRect(-28*dpr,-16*dpr,56*dpr,22*dpr,6*dpr); s.fill(); s.stroke();
  s.fillStyle='#fff'; s.font=(12*dpr)+'px system-ui'; s.textAlign='center'; s.textBaseline='middle';
  s.fillText(Math.round(ang*180/Math.PI)+'°',0,-5*dpr); s.restore();
}

/* ==== history (dataURL + HTML) ==== */
const hist=[], redoStack=[];
function snapshot(){ return { url: cv.toDataURL(), texts: textLayer.innerHTML }; }
function pushHistory(){ hist.push(snapshot()); if(hist.length>10) hist.shift(); redoStack.length=0; }
function restore(snap){
  return new Promise(res=>{
    clear(cv); textLayer.innerHTML=snap?.texts||'';
    if(!snap?.url) return res();
    const img=new Image(); img.onload=()=>{ ctx.drawImage(img,0,0); res(); }; img.src=snap.url;
  });
}
async function undo(){ if(!hist.length) return; const cur=snapshot(); const prev=hist.pop(); redoStack.push(cur); await restore(prev); }
async function redo(){ const snap=redoStack.pop(); if(!snap) return; hist.push(snapshot()); await restore(snap); }
$('#btnUndo').addEventListener('click',()=>undo());
$('#btnRedo').addEventListener('click',()=>redo());

/* ==== pointer ==== */
let straightHUD=null;
cv.addEventListener('pointerdown', async e=>{
  e.preventDefault(); cv.setPointerCapture(e.pointerId);
  setCtx(); startPt=pt(e); drawing=true; ctx.beginPath(); ctx.moveTo(startPt.x,startPt.y);
  if(straightKey||$('#uiStraight').checked) straightHUD={p0:startPt};
  await pushHistory();
},{passive:false});
cv.addEventListener('pointermove', e=>{
  if(!drawing) return; const p=pt(e);
  clear(cvGuide);
  if(straightKey||$('#uiStraight').checked){
    const sp=snapLine(startPt,p); ctx.beginPath(); ctx.moveTo(startPt.x,startPt.y); ctx.lineTo(sp.x,sp.y); ctx.stroke(); drawAngleHUD(sp,sp.ang); return;
  }
  ctx.lineTo(p.x,p.y); ctx.stroke();
},{passive:false});
cv.addEventListener('pointerup', ()=>{drawing=false; startPt=null; clear(cvGuide)},{passive:false});

/* ==== keyboard (Shift) ==== */
addEventListener('keydown',e=>{ if(e.key==='Shift') straightKey=true; });
addEventListener('keyup',e=>{ if(e.key==='Shift') straightKey=false; });

/* ==== text ==== */
function addText(){
  const el=document.createElement('div'); el.className='note-text'; el.contentEditable='true';
  el.style.left=(80+Math.random()*40)+'px'; el.style.top=(60+Math.random()*40)+'px';
  el.textContent='テキスト'; const del=document.createElement('button'); del.className='del'; del.textContent='削除';
  del.addEventListener('click',()=>el.remove()); el.appendChild(del); textLayer.appendChild(el); el.focus();
}
$('#btnTextAdd').addEventListener('click', addText);
$('#btnTextBold').addEventListener('click',()=>document.execCommand('bold',false,null));
$('#btnTextIt').addEventListener('click',()=>document.execCommand('italic',false,null));
$('#btnTextDel').addEventListener('click',()=>document.execCommand('delete',false,null));
$('#btnTextBoxDel').addEventListener('click',()=>{
  const sel=window.getSelection(); if(!sel.rangeCount) return;
  let el=sel.anchorNode; while(el && !(el instanceof HTMLElement && el.classList.contains('note-text'))) el=el.parentNode;
  if(el) el.remove();
});
textLayer.addEventListener('pointerdown',e=>{
  const el=e.target.closest('.note-text'); if(!el) return; e.preventDefault();
  const r=el.getBoundingClientRect(), base=textLayer.getBoundingClientRect();
  let sx=e.clientX, sy=e.clientY, ox=r.left-base.left, oy=r.top-base.top; let drag=true;
  el.setPointerCapture(e.pointerId);
  function mv(ev){ if(!drag) return; el.style.left=(ox+(ev.clientX-sx))+'px'; el.style.top=(oy+(ev.clientY-sy))+'px'; }
  function up(){ drag=false; el.releasePointerCapture(e.pointerId); textLayer.removeEventListener('pointermove',mv); textLayer.removeEventListener('pointerup',up); }
  textLayer.addEventListener('pointermove',mv,{passive:false}); textLayer.addEventListener('pointerup',up,{passive:false});
},{passive:false});

/* ==== PNG / Print / Share ==== */
function composite(){
  const out=document.createElement('canvas'); out.width=cv.width; out.height=cv.height;
  const o=out.getContext('2d');
  o.fillStyle=getComputedStyle(document.documentElement).getPropertyValue('--bg').trim()||'#0b1020';
  o.fillRect(0,0,out.width,out.height); o.drawImage(cvGrid,0,0); o.drawImage(cv,0,0);
  [...textLayer.querySelectorAll('.note-text')].forEach(n=>{
    const r=n.getBoundingClientRect(), layer=textLayer.getBoundingClientRect();
    const x=(r.left-layer.left)*DPR, y=(r.top-layer.top)*DPR;
    o.fillStyle='#eaf3ff'; o.font=(16*DPR)+'px system-ui'; o.fillText(n.textContent.trim(), x, y+16*DPR);
  });
  return out;
}
$('#btnPng').addEventListener('click',()=>composite().toBlob(b=>{const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download='note-link.png';a.click();setTimeout(()=>URL.revokeObjectURL(a.href),800)}));
$('#btnPrint').addEventListener('click',()=>window.print());
$('#btnShare').addEventListener('click',()=>{
  composite().toBlob(async b=>{
    if(navigator.share && navigator.canShare && navigator.canShare({files:[new File([b],'note.png',{type:'image/png'})]})){
      try{ await navigator.share({files:[new File([b],'note.png',{type:'image/png'})],title:'Note Link'});}catch(e){}
    }else{ const u=URL.createObjectURL(b); const a=document.createElement('a'); a.href=u; a.download='note-link.png'; a.click(); setTimeout(()=>URL.revokeObjectURL(u),800); }
  });
});

/* ==== init ==== */
function init(){
  applyTopbarHeight(); resize();
  setActiveTool('pen'); syncUI();
  // 初期スナップショット
  hist.length=0; redoStack.length=0; pushHistory();
  // ⚙の初期状態
  $$('.tool').forEach(b=>{ if(b.dataset.tool==='settings') b.classList.toggle('active', panel.classList.contains('show'));});
}
init();
</script>
</body>
</html>
