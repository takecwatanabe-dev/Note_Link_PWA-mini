<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Note Link mini – v0.6.9-fix18-toolbar-hotfix</title>
<style>
/* -------------------------------------------------------
   Note Link UI (toolbar-only hotfix)
   version : v0.6.9-fix18-toolbar-hotfix / No.13
   purpose : △/▽ 折畳み、緑の選択ライン、上部バー直下に固定、
             折畳み時 45px、z-index/クリック不能対策、
             ギア(⚙)で現在ツールのパネル表示/非表示
   author  : ChatGPT
--------------------------------------------------------*/

/* ===== Theme tokens ===== */
:root{
  --ink:#e6f1ff;           /* 文字/アイコン */
  --ink-dim:#9bd6e9;       /* 補助文字 */
  --bg:#0b1020;            /* 背景 */
  --panel:#0f1420;         /* 設定パネル */
  --accent:#44a7ff;        /* 上部バーの青 */
  --accent-weak:#2a54ff;   /* 影の青味 */
  --ok:#2dd4bf;            /* 緑(選択の枠) */
  --danger:#ff4444;        /* 破壊操作 */
  --muted:#27324a;         /* 線/境界 */
  --shadow:0 10px 24px rgba(0,0,0,.45);
}

/* ===== Reset-ish ===== */
*{box-sizing:border-box}
html,body{height:100%}
html{background:var(--bg);color:var(--ink);
  font-family:system-ui, -apple-system, "Segoe UI", Roboto, "Hiragino Kaku Gothic ProN", Meiryo, sans-serif;}
a{color:inherit}

/* ===== Topbar ===== */
:root{ --topbar-h:44px; --toolbar-w:56px; }
header.topbar{
  position:sticky; top:0; left:0; right:0; z-index:60;
  height:var(--topbar-h);
  display:flex; align-items:center; gap:8px;
  padding:0 10px; color:#fff; font-size:12px;
  background:linear-gradient(0deg, rgba(42,84,255,.16), rgba(42,84,255,.16)), var(--accent);
  border-bottom:1px solid rgba(255,255,255,.15);
  box-shadow:0 1px 0 rgba(0,0,0,.6) inset;
}
header.topbar .spacer{ flex:1 }
header.topbar .btn{
  height:28px; padding:0 10px; border-radius:10px; display:inline-flex; align-items:center; gap:6px;
  background:rgba(255,255,255,.2); border:1px solid rgba(255,255,255,.22); color:#fff;
}
header.topbar .btn:active{ transform:translateY(1px); }
header.topbar .build{ opacity:.8 }

/* ===== Wrap / Stage ===== */
#wrap{ position:relative; }
#stage{ position:absolute; inset:0;
  /* ここに既存のキャンバスが重なっていてもOK。UIは z-index で前面 */
}

/* ===== Sidebar (Tool bar) ===== */
.sidebar{
  position:fixed; z-index:58; left:0; top:var(--topbar-h); bottom:0;
  width:var(--toolbar-w);
  display:flex; flex-direction:column; align-items:center;
  background:rgba(0,0,0,.82); box-shadow:0 0 0 1px var(--muted) inset;
}
.sidebar .rail{ width:100%; padding:6px; display:flex; flex-direction:column; gap:8px; }
.tool{
  display:grid; place-items:center; width:100%; height:36px;
  border-radius:10px; cursor:pointer; user-select:none;
  background:rgba(25,25,35,.65); outline:2px solid rgba(79,124,255,.35); outline-offset:0;
  border:1px solid rgba(45,55,104,.65);
  box-shadow:0 0 0 2px rgba(0,0,0,.12);
}
.tool svg{ width:18px; height:18px; stroke:var(--ink); fill:none; stroke-width:2.2; }
.tool:hover{ outline:2px solid rgba(79,124,255,.55); }
.tool.active{ outline:2px solid var(--ok); }
.tool[data-tool="toggle"] svg{ transform:rotate(0deg); transition:transform .2s ease; }
.sidebar.collapsed .tool[data-tool="toggle"] svg{ transform:rotate(180deg); }
/* 折畳み：45px 高さで▽のみ残す */
.sidebar.collapsed .rail > .tool:not([data-tool="toggle"]){ display:none; }
.sidebar.collapsed{ width:var(--toolbar-w); }
.sidebar.collapsed .rail{ padding-top:6px; }
.sidebar.collapsed{ clip-path:inset(0 0 calc(100% - 45px) 0); }

/* 常時青になるバグ対策：選択は .active のみ */
.tool:focus-visible{ outline:2px dashed var(--ink-dim); }

/* ===== Floating panel (設定) ===== */
.panel{
  position:absolute; z-index:59; left:64px; top:calc(var(--topbar-h) + 10px);
  min-width:320px; padding:14px 14px 10px; border-radius:14px;
  color:var(--ink); background:var(--panel); border:1px solid rgba(255,255,255,.14);
  box-shadow:var(--shadow); display:none;
}
.panel.show{ display:block; }
.panel .row{ display:flex; align-items:center; gap:10px; margin:10px 0; }
.panel .row label{ width:76px; font-size:12px; color:var(--ink-dim) }
.panel .close{
  position:absolute; right:10px; top:10px; height:26px; padding:0 10px; border-radius:8px;
  border:1px solid rgba(255,255,255,.18); background:rgba(255,255,255,.08); color:var(--ink); font-size:12px;
}

/* ===== Tips (ホバーのラベル) ===== */
[data-tip]{ position:relative; }
[data-tip]::after{
  content:attr(data-tip); position:absolute; left:48px; top:50%; transform:translateY(-50%);
  background:#222a; color:#fff; font-size:12px; padding:4px 8px; border-radius:8px; white-space:nowrap;
  pointer-events:none; opacity:0; translate:0 -4px; transition:.15s;
}
[data-tip]:hover::after{ opacity:1; translate:0 0; }

/* ===== Layout safety ===== */
#wrap, #stage{ padding-left:var(--toolbar-w); } /* ツールバーが重ならないよう左余白 */
@media (max-width:480px){
  .panel{ min-width:280px; }
}
</style>
</head>
<body>

<header class="topbar" id="topbar" style="writing-mode:horizontal-tb">
  <strong>Note Link v0.6.9-fix18 / No.13</strong>
  <span class="spacer"></span>
  <button class="btn" id="btnUndo">undo</button>
  <button class="btn" id="btnRedo">redo</button>
  <button class="btn" id="btnPrint">印刷</button>
  <button class="btn" id="btnPng">PNG</button>
  <button class="btn" id="btnShare">共有</button>
  <span class="build">build: toolbar-hotfix</span>
</header>

<aside class="sidebar" id="sidebar">
  <div class="rail">
    <!-- △/▽ トグル（中抜き、回転はCSS） -->
    <button class="tool active" data-tool="toggle" data-tip="ツールバーの開閉">
      <svg viewBox="0 0 24 24" aria-hidden="true">
        <path d="M5 15 L12 7 L19 15" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </button>
    <!-- ペン -->
    <button class="tool" data-tool="pen" data-tip="ペン">
      <svg viewBox="0 0 24 24"><path d="M3 21l4-1 12-12-3-3L4 17l-1 4zM14 6l3 3"/></svg>
    </button>
    <!-- マーカー -->
    <button class="tool" data-tool="marker" data-tip="マーカー">
      <svg viewBox="0 0 24 24"><path d="M3 16l10-10 5 5-10 10-5 1 1-6zM13 6l5 5"/></svg>
    </button>
    <!-- 消しゴム -->
    <button class="tool" data-tool="eraser" data-tip="消しゴム">
      <svg viewBox="0 0 24 24"><path d="M3 15l8-8 6 6-6 6H7zM13 7l4 4"/></svg>
    </button>
    <!-- テキスト -->
    <button class="tool" data-tool="text" data-tip="テキスト">
      <svg viewBox="0 0 24 24"><path d="M4 7h16M12 7v10M8 17h8" /></svg>
    </button>
    <!-- 設定（⚙） -->
    <button class="tool" data-tool="settings" data-tip="ツール設定（表示/非表示）">
      <svg viewBox="0 0 24 24"><path d="M12 8.5a3.5 3.5 0 1 1 0 7 3.5 3.5 0 0 1 0-7zM4 13h2l1 2  -1 2H4l-1-2 1-2zm14 0h2l1 2-1 2h-2l-1-2 1-2zM8 4h2l2 1 2-1h2l1 2-1 2h-2l-2-1-2 1H8L7 6 8 4z" stroke-linecap="round" stroke-linejoin="round"/></svg>
    </button>
  </div>
</aside>

<!-- 設定パネル（今選んでいるツール用。内容は最小） -->
<div class="panel" id="panel">
  <button class="close" id="panelClose">閉じる</button>
  <div class="row"><label>ツール</label><div id="panelToolName">-</div></div>
  <div class="row"><label>太さ</label><input type="range" min="1" max="40" value="4" id="uiSize"><span id="uiSizeVal">4px</span></div>
  <div class="row"><label>不透明度</label><input type="range" min="10" max="100" value="100" id="uiAlpha"><span id="uiAlphaVal">100%</span></div>
</div>

<div id="wrap">
  <div id="stage"><!-- 既存のキャンバス / 画像 / SVG をここに置く（UIは前面固定） --></div>
</div>

<script>
/* ======================================================
   Toolbar-only hotfix script
   - 既存アプリの描画エンジンを壊さないよう、UIイベントを
     CustomEvent で外へ通知。既存の関数があれば呼ぶ。
====================================================== */

const qs = sel => document.querySelector(sel);
const qsa = sel => Array.from(document.querySelectorAll(sel));
const sidebar = qs('#sidebar');
const panel = qs('#panel');
const panelClose = qs('#panelClose');
const topbar = qs('#topbar');

let currentTool = 'pen';

/* ---- 上部バー配下を強制横書き（スマホの縦書き化対策） ---- */
topbar.style.writingMode = 'horizontal-tb';

/* ---- ツール選択・ラインの管理 ---- */
function setActive(tool){
  currentTool = tool;
  qsa('.tool').forEach(b=>b.classList.toggle('active', b.dataset.tool===tool));
  qs('#panelToolName').textContent = tool;
  // 既存エンジンへ通知（受け側があれば動く）
  window.dispatchEvent(new CustomEvent('tool:select', { detail:{ tool } }));
  if(tool!=='settings'){ hidePanel(); }
}
qsa('.tool').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    const t = btn.dataset.tool;
    if(t==='toggle'){
      sidebar.classList.toggle('collapsed');
      return;
    }
    if(t==='settings'){
      togglePanel();
      return;
    }
    setActive(t);
  });
});

/* ---- パネルの表示/非表示・ドラッグ移動 ---- */
function showPanel(){ panel.classList.add('show'); }
function hidePanel(){ panel.classList.remove('show'); }
function togglePanel(){ panel.classList.toggle('show'); }
panelClose.addEventListener('click', hidePanel);

// ドラッグ移動（パネル上部どこでも）
(function makeDraggable(el){
  let sx=0, sy=0, ox=0, oy=0, dragging=false;
  el.addEventListener('pointerdown', (e)=>{
    if(e.button!==0) return;
    dragging=true; sx=e.clientX; sy=e.clientY;
    const rect = el.getBoundingClientRect(); ox=rect.left; oy=rect.top;
    el.setPointerCapture(e.pointerId);
  });
  el.addEventListener('pointermove', (e)=>{
    if(!dragging) return;
    const x = ox + (e.clientX - sx);
    const y = oy + (e.clientY - sy);
    el.style.left = Math.max(56, x) + 'px';
    el.style.top  = Math.max(parseInt(getComputedStyle(document.documentElement).getPropertyValue('--topbar-h')) + 6, y) + 'px';
  });
  el.addEventListener('pointerup', ()=> dragging=false);
})(panel);

/* ---- UI スライダを表示値と連動 ---- */
const uiSize = qs('#uiSize');
const uiAlpha = qs('#uiAlpha');
const uiSizeVal = qs('#uiSizeVal');
const uiAlphaVal = qs('#uiAlphaVal');
function syncSliders(){
  uiSizeVal.textContent = uiSize.value + 'px';
  uiAlphaVal.textContent = uiAlpha.value + '%';
  // 外部通知（既存コードが受けるなら反映）
  window.dispatchEvent(new CustomEvent('tool:param', {
    detail:{ tool:currentTool, size:+uiSize.value, alpha:+uiAlpha.value/100 }
  }));
}
uiSize.addEventListener('input', syncSliders);
uiAlpha.addEventListener('input', syncSliders);
syncSliders();

/* ---- 上部バーのボタン（既存関数があれば呼ぶ） ---- */
const callIf = (name,...args)=>{
  if (typeof window[name]==='function'){ try{ window[name](...args); }catch(e){} }
};
qs('#btnUndo').addEventListener('click', ()=>{ callIf('appUndo');  window.dispatchEvent(new Event('ui:undo')) });
qs('#btnRedo').addEventListener('click', ()=>{ callIf('appRedo');  window.dispatchEvent(new Event('ui:redo')) });
qs('#btnPrint').addEventListener('click',()=>{ callIf('appPrint'); window.dispatchEvent(new Event('ui:print')) });
qs('#btnPng').addEventListener('click',  ()=>{ callIf('appExportPNG'); window.dispatchEvent(new Event('ui:png')) });
qs('#btnShare').addEventListener('click',()=>{ callIf('appShare'); window.dispatchEvent(new Event('ui:share')) });

/* ---- 初期状態 ---- */
setActive('pen');
hidePanel();

/* ---- クリック不能の根治：UIは z-index 58–60。キャンバスはそれ未満に。 ---- */
/* このファイルは UI だけなので描画ロジックは不触。既存キャンバスが
   UIをブロックする場合は #stage 側の z-index を 10 未満にしてください。 */

</script>
</body>
</html>
